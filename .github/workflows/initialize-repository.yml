name: Initialize Repository

on:
  workflow_dispatch:
    inputs:
      package_name:
        description: 'Python package name (e.g., mail_fetcher) - must use underscores'
        required: true
        type: string
      cli_name:
        description: 'CLI executable name (e.g., ma-fe) - must use hyphens if multi-word'
        required: true
        type: string

run-name: Initialize Repository - ${{ inputs.package_name }}

jobs:
  initialize:
    name: Initialize Repository
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if already initialized
        run: |
          if [ ! -d "my_package" ]; then
            echo "‚ùå Error: Repository has already been initialized!"
            echo ""
            echo "The 'my_package' directory no longer exists, which means this repository"
            echo "has already been customized. This workflow should only be run once."
            echo ""
            echo "If you need to rename your package again, please do so manually or"
            echo "create a fresh repository from the template."
            exit 1
          fi
          echo "‚úÖ Repository not yet initialized, proceeding..."

      - name: Validate inputs
        run: |
          PACKAGE_NAME="${{ inputs.package_name }}"
          CLI_NAME="${{ inputs.cli_name }}"

          # Validate package_name uses underscores (no hyphens)
          if [[ "$PACKAGE_NAME" =~ - ]]; then
            echo "‚ùå Error: package_name must use underscores, not hyphens (e.g., weather_fetcher)"
            echo "   You provided: $PACKAGE_NAME"
            exit 1
          fi

          # Validate package_name is a valid Python identifier
          if ! python3 -c "import sys; sys.exit(0 if '$PACKAGE_NAME'.isidentifier() else 1)"; then
            echo "‚ùå Error: package_name must be a valid Python identifier"
            echo "   You provided: $PACKAGE_NAME"
            exit 1
          fi

          # Validate CLI_NAME doesn't contain underscores
          if [[ "$CLI_NAME" =~ _ ]]; then
            echo "‚ö†Ô∏è  Warning: cli_name contains underscores. Convention is to use hyphens for multi-word CLI names."
            echo "   You provided: $CLI_NAME"
            echo "   Consider using: ${CLI_NAME//_/-}"
          fi

          echo "‚úÖ Validation passed"
          echo "   Package name: $PACKAGE_NAME"
          echo "   CLI name: $CLI_NAME"

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Rename package directory
        run: |
          if [ -d "my_package" ]; then
            mv my_package "${{ inputs.package_name }}"
            echo "‚úÖ Renamed my_package/ to ${{ inputs.package_name }}/"
          else
            echo "‚ö†Ô∏è  my_package directory not found, skipping"
          fi

      - name: Update Makefile
        run: |
          sed -i 's/^PACKAGE_NAME = my_package$/PACKAGE_NAME = ${{ inputs.package_name }}/' Makefile
          sed -i 's/^CLI_NAME = my-cli$/CLI_NAME = ${{ inputs.cli_name }}/' Makefile
          echo "‚úÖ Updated Makefile"

      - name: Update pyproject.toml
        run: |
          # Convert package_name underscores to hyphens for distribution name (PEP 508)
          DIST_NAME="${{ inputs.package_name }}"
          DIST_NAME="${DIST_NAME//_/-}"

          # Update project name
          sed -i "s/^name = \"my-package\"$/name = \"$DIST_NAME\"/" pyproject.toml

          # Update CLI script entry point
          sed -i "s/^my-cli = \"my_package\.main:app\"$/${{ inputs.cli_name }} = \"${{ inputs.package_name }}.main:app\"/" pyproject.toml

          # Update packages list
          sed -i "s/^packages = \[\"my_package\"\]$/packages = [\"${{ inputs.package_name }}\"]/" pyproject.toml

          echo "‚úÖ Updated pyproject.toml"

      - name: Update imports
        run: |
          # Convert package_name underscores to hyphens for distribution name (PEP 508)
          DIST_NAME="${{ inputs.package_name }}"
          DIST_NAME="${DIST_NAME//_/-}"

          # Update all Python files in tests directory
          find tests -name "*.py" -type f -exec sed -i "s/from my_package\./from ${{ inputs.package_name }}./g" {} +
          find tests -name "*.py" -type f -exec sed -i "s/import my_package/import ${{ inputs.package_name }}/g" {} +

          # Update all Python files in package directory
          find "${{ inputs.package_name }}" -name "*.py" -type f -exec sed -i "s/from my_package\./from ${{ inputs.package_name }}./g" {} +
          find "${{ inputs.package_name }}" -name "*.py" -type f -exec sed -i "s/import my_package/import ${{ inputs.package_name }}/g" {} +

          # Update version() call in main.py to use the distribution name
          sed -i "s/version(\"my-package\")/version(\"$DIST_NAME\")/" "${{ inputs.package_name }}/main.py"

          echo "‚úÖ Updated imports and version() call in package files"

      - name: Verify changes
        run: |
          echo "üìã Changed files:"
          git status --short

          echo ""
          echo "üìù Makefile changes:"
          git diff Makefile || true

          echo ""
          echo "üìù pyproject.toml changes:"
          git diff pyproject.toml || true

          echo ""
          echo "üìù Test file changes:"
          git diff tests/ || true

          echo ""
          echo "üìù Package file changes:"
          git diff "${{ inputs.package_name }}/" || true

      - name: Run validation checks
        run: |
          # Install dependencies and set up hooks
          make deps

          # Run validation (lint, format, test)
          make validate

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add -A

          git commit -m "$(cat <<'EOF'
          chore: initialize repository

          - Package name: ${{ inputs.package_name }}
          - CLI name: ${{ inputs.cli_name }}

          Automated initialization performed by GitHub Actions workflow.
          EOF
          )"

          git push

          echo "‚úÖ Changes committed and pushed successfully!"

      - name: Summary
        if: success()
        run: |
          echo "üéâ Repository initialization complete!"
          echo ""
          echo "üì¶ Package name: ${{ inputs.package_name }}"
          echo "‚ö° CLI name: ${{ inputs.cli_name }}"
          echo ""
          echo "Next steps:"
          echo "1. Pull the latest changes: git pull"
          echo "2. Install dependencies and hooks: make deps"
          echo "3. Install the CLI: make install"
          echo "4. Test your CLI: ${{ inputs.cli_name }} --help"

          # Add to workflow summary
          cat >> $GITHUB_STEP_SUMMARY <<'EOF'
          ## üéâ Repository Initialization Complete!

          **Configuration:**
          - üì¶ Package name: `${{ inputs.package_name }}`
          - ‚ö° CLI name: `${{ inputs.cli_name }}`

          ### Next Steps

          1. **Pull the latest changes:**
             ```bash
             git pull
             ```

          2. **Install dependencies and set up hooks:**
             ```bash
             make deps
             ```

          3. **Install the CLI:**
             ```bash
             make install
             ```

          4. **Test your CLI:**
             ```bash
             ${{ inputs.cli_name }} --help
             ```

          ---

          You're all set! Start building your CLI by modifying the commands in `${{ inputs.package_name }}/commands/`.
          EOF
